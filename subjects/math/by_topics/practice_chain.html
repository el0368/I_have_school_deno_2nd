<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practice Chain — 1,823 Exercises</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --dot-size: 18px;
        --dot-border: 1.5px;
      }

      /* ── Dark Theme ─────────────────────────────── */
      [data-theme="dark"] {
        --bg: #0f1117;
        --bg-header: #161825;
        --bg-panel: #161825;
        --bg-input: #1e2030;
        --bg-tier: #12141e;
        --bg-btn: #1e2030;
        --bg-btn-hover: #252838;
        --bg-row-hover: #14162080;
        --bg-row-active: #1a1d3060;
        --bg-tag: #1a1c2e;
        --bg-tooltip: #1e2030ee;
        --border: #232640;
        --border-light: #1e2038;
        --border-row: #1a1c2e;
        --border-btn: #2d3148;
        --text: #d0d4dc;
        --text-heading: #e4e7ee;
        --text-sub: #6b7280;
        --text-dim: #4b5563;
        --text-faint: #3b4058;
        --text-label: #b0b6c4;
        --scrollbar: #2d3148;
        --dot-color: #6b7280;
        --accent: #4f8ff7;
        --start-btn-bg: #1e6b3a;
        --start-btn-hover: #22803f;
        --start-btn-text: #bbf7d0;
      }

      /* ── Light Theme ────────────────────────────── */
      [data-theme="light"] {
        --bg: #f5f6f8;
        --bg-header: #ffffff;
        --bg-panel: #ffffff;
        --bg-input: #f0f1f4;
        --bg-tier: #ebedf1;
        --bg-btn: #ebedf1;
        --bg-btn-hover: #dfe1e6;
        --bg-row-hover: #f0f1f480;
        --bg-row-active: #e8eaf060;
        --bg-tag: #e4e6eb;
        --bg-tooltip: #ffffffee;
        --border: #d1d5db;
        --border-light: #e5e7eb;
        --border-row: #e5e7eb;
        --border-btn: #d1d5db;
        --text: #1f2937;
        --text-heading: #111827;
        --text-sub: #6b7280;
        --text-dim: #9ca3af;
        --text-faint: #d1d5db;
        --text-label: #374151;
        --scrollbar: #c4c8d0;
        --dot-color: #9ca3af;
        --accent: #2563eb;
        --start-btn-bg: #16a34a;
        --start-btn-hover: #15803d;
        --start-btn-text: #ffffff;
      }

      body {
        font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
        background: var(--bg);
        color: var(--text);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* ── Header Bar ─────────────────────────────── */
      #header {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 12px 24px;
        background: var(--bg-header);
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
      }

      #header h1 {
        font-size: 17px;
        font-weight: 600;
        color: var(--text-heading);
        white-space: nowrap;
      }

      #header .subtitle {
        font-size: 12px;
        color: var(--text-sub);
        white-space: nowrap;
      }

      #search-wrap {
        flex: 1;
        max-width: 340px;
        position: relative;
      }

      #search {
        width: 100%;
        padding: 7px 12px 7px 32px;
        background: var(--bg-input);
        border: 1px solid var(--border-btn);
        border-radius: 6px;
        color: var(--text);
        font-size: 13px;
        outline: none;
      }
      #search:focus {
        border-color: var(--accent);
      }
      #search::placeholder {
        color: var(--text-dim);
      }

      #search-icon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 13px;
        color: var(--text-dim);
        pointer-events: none;
      }

      /* ── Header Control Buttons ─────────────────── */
      .header-controls {
        display: flex;
        align-items: center;
        gap: 4px;
        margin-left: auto;
      }

      .hdr-btn {
        width: 30px;
        height: 30px;
        background: var(--bg-btn);
        border: 1px solid var(--border-btn);
        border-radius: 5px;
        color: var(--text-sub);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        user-select: none;
      }

      .hdr-btn:hover {
        background: var(--bg-btn-hover);
        color: var(--text-heading);
        border-color: var(--accent);
      }

      .hdr-btn:active {
        transform: scale(0.95);
      }

      .hdr-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }
      .hdr-btn:disabled:hover {
        background: var(--bg-btn);
        color: var(--text-sub);
        border-color: var(--border-btn);
      }

      .hdr-sep {
        width: 1px;
        height: 22px;
        background: var(--border);
        margin: 0 6px;
      }

      .hdr-label {
        font-size: 10px;
        color: var(--text-dim);
        min-width: 32px;
        text-align: center;
        user-select: none;
      }

      /* ── Content Layout ─────────────────────────── */
      #content {
        flex: 1;
        display: flex;
        overflow: hidden;
        position: relative;
      }

      /* ── Track Area (left/main) ─────────────────── */
      #tracks {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 0 0 40px;
      }

      #tracks::-webkit-scrollbar {
        width: 6px;
      }
      #tracks::-webkit-scrollbar-track {
        background: transparent;
      }
      #tracks::-webkit-scrollbar-thumb {
        background: var(--scrollbar);
        border-radius: 3px;
      }

      /* ── Tier Sections ──────────────────────────── */
      .tier-header {
        position: sticky;
        top: 0;
        z-index: 20;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 24px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        background: var(--bg-tier);
        color: var(--text);
        border-bottom: 1px solid var(--border-light);
        cursor: pointer;
        user-select: none;
      }

      .tier-header .tier-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
      }

      .tier-header .tier-count {
        font-weight: 400;
        color: var(--text-dim);
        margin-left: 4px;
      }

      .tier-header .chevron {
        margin-left: auto;
        transition: transform 0.2s;
        color: var(--text-dim);
        font-size: 10px;
      }

      .tier-header.collapsed .chevron {
        transform: rotate(-90deg);
      }

      .tier-body {
        overflow: hidden;
      }
      .tier-body.collapsed {
        display: none;
      }

      /* ── Topic Row ──────────────────────────────── */
      .topic-row {
        display: flex;
        align-items: flex-start;
        border-bottom: 1px solid var(--border-row);
        min-height: 44px;
        transition: background 0.15s;
      }

      .topic-row:hover {
        background: var(--bg-row-hover);
      }
      .topic-row.active-topic {
        background: var(--bg-row-active);
      }

      .topic-label {
        width: 240px;
        min-width: 240px;
        padding: 10px 14px 10px 24px;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-label);
        display: flex;
        align-items: flex-start;
        gap: 6px;
        line-height: 1.4;
        position: sticky;
        left: 0;
        background: inherit;
        z-index: 5;
      }

      .topic-label .topic-num {
        color: var(--text-dim);
        font-size: 12px;
        font-weight: 400;
        min-width: 22px;
      }

      .topic-label .topic-name {
        flex: 1;
      }

      .topic-label .topic-count {
        font-size: 11px;
        color: var(--text-faint);
        font-weight: 400;
      }

      /* ── Practice Dots Area ─────────────────────── */
      .topic-practices {
        flex: 1;
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        padding: 8px 16px 8px 0;
        gap: 0;
      }

      .grade-group {
        display: inline-flex;
        align-items: center;
        flex-wrap: wrap;
        margin-right: 6px;
        margin-bottom: 2px;
      }

      .grade-tag {
        font-size: 9px;
        font-weight: 600;
        color: var(--text-faint);
        padding: 1px 5px;
        margin-right: 2px;
        white-space: nowrap;
        letter-spacing: 0.3px;
        text-transform: uppercase;
        border-radius: 3px;
        background: var(--bg-tag);
        line-height: 1.4;
        user-select: none;
        align-self: center;
      }

      .dot {
        display: inline-block;
        width: var(--dot-size);
        height: var(--dot-size);
        border-radius: 50%;
        margin: 2px;
        cursor: pointer;
        transition: box-shadow 0.12s, opacity 0.2s, width 0.2s, height 0.2s, background 0.2s;
        position: relative;
        flex-shrink: 0;
        background: transparent;
        border: var(--dot-border) solid var(--dot-color);
        box-sizing: border-box;
        color: var(--dot-color);
      }

      /* Progress states */
      .dot.progress-half {
        background: linear-gradient(90deg, var(--dot-color) 50%, transparent 50%);
      }

      .dot.progress-full {
        background: var(--dot-color);
      }

      .dot.progress-fail {
        border-color: #ef4444;
        color: #ef4444;
      }

      .dot.progress-fail::before {
        content: "\u2715";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #ef4444;
        font-size: calc(var(--dot-size) * 0.55);
        font-weight: bold;
        line-height: 1;
      }

      .dot:hover {
        box-shadow: 0 0 0 2px var(--accent);
        z-index: 10;
      }

      /* Chain highlights */
      .dot.selected {
        border-color: var(--text-heading);
        box-shadow: 0 0 0 3px var(--text-heading);
        z-index: 15;
      }

      .dot.prereq {
        border-color: #fbbf24;
        box-shadow: 0 0 0 2px #fbbf24;
        z-index: 8;
      }

      .dot.unlock {
        border-color: #38bdf8;
        box-shadow: 0 0 0 2px #38bdf8;
        z-index: 8;
      }

      .dot.chain {
        opacity: 0.9;
      }

      .dot.dimmed {
        opacity: 0.12;
      }

      .dot.search-match {
        border-color: #fbbf24;
        box-shadow: 0 0 0 2px #fbbf24;
        z-index: 9;
      }

      .dot.search-miss {
        opacity: 0.12;
      }

      .grade-sep {
        display: inline-block;
        width: 1px;
        height: 14px;
        background: var(--border);
        margin: 0 4px;
        align-self: center;
        flex-shrink: 0;
      }

      /* ── Detail Panel (right side) ──────────────── */
      #detail-panel {
        width: 320px;
        min-width: 320px;
        background: var(--bg-panel);
        border-left: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: width 0.2s, min-width 0.2s;
      }

      #detail-panel.collapsed {
        width: 0;
        min-width: 0;
        border-left: none;
      }

      #detail-header {
        padding: 16px 20px 12px;
        border-bottom: 1px solid var(--border);
      }

      #detail-header h2 {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-heading);
        margin-bottom: 4px;
        line-height: 1.4;
      }

      #detail-meta {
        font-size: 12px;
        color: var(--text-sub);
        line-height: 1.5;
      }

      #detail-meta .topic-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 4px;
        background: var(--bg-input);
        font-size: 11px;
        margin-top: 4px;
      }

      #detail-meta .topic-badge .mini-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        border: 1.5px solid var(--dot-color);
      }

      #detail-body {
        flex: 1;
        overflow-y: auto;
        padding: 0;
      }

      #detail-body::-webkit-scrollbar {
        width: 5px;
      }
      #detail-body::-webkit-scrollbar-track {
        background: transparent;
      }
      #detail-body::-webkit-scrollbar-thumb {
        background: var(--scrollbar);
        border-radius: 3px;
      }

      .detail-section {
        padding: 14px 20px;
        border-bottom: 1px solid var(--border-light);
      }

      .detail-section h3 {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-dim);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .detail-section h3 .badge {
        font-size: 10px;
        background: var(--bg-input);
        padding: 1px 6px;
        border-radius: 8px;
        color: var(--text-sub);
        letter-spacing: 0;
        text-transform: none;
      }

      .dep-item {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 5px 8px;
        margin: 2px 0;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        line-height: 1.35;
        transition: background 0.1s;
      }

      .dep-item:hover {
        background: var(--bg-input);
      }

      .dep-item .arrow {
        flex-shrink: 0;
        width: 14px;
        text-align: center;
        font-size: 11px;
        margin-top: 1px;
      }

      .dep-item .dep-name {
        flex: 1;
        color: var(--text-label);
      }

      .dep-item .dep-context {
        font-size: 10px;
        white-space: nowrap;
        color: var(--text-sub);
      }

      /* ── Start Practice Button ──────────────────── */
      .start-practice-btn {
        display: block;
        width: 100%;
        padding: 12px 16px;
        background: var(--start-btn-bg);
        border: none;
        border-radius: 8px;
        color: var(--start-btn-text);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.15s;
        text-align: center;
      }

      .start-practice-btn:hover {
        background: var(--start-btn-hover);
      }

      /* Empty state */
      #empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 24px;
        text-align: center;
        color: var(--text-faint);
      }

      #empty-state .icon {
        font-size: 40px;
        margin-bottom: 12px;
        opacity: 0.5;
      }

      #empty-state p {
        font-size: 13px;
        line-height: 1.6;
        max-width: 220px;
      }

      #empty-state p strong {
        color: var(--text-sub);
      }

      /* ── Toggle detail panel button ─────────────── */
      #toggle-panel {
        position: absolute;
        right: 320px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 48px;
        background: var(--bg-btn);
        border: 1px solid var(--border);
        border-right: none;
        border-radius: 6px 0 0 6px;
        color: var(--text-dim);
        font-size: 11px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 30;
        transition: right 0.2s, color 0.15s;
      }
      #toggle-panel:hover {
        color: var(--text-heading);
      }
      #toggle-panel.panel-hidden {
        right: 0;
      }

      /* ── Tooltip ────────────────────────────────── */
      #tooltip {
        position: fixed;
        pointer-events: none;
        background: var(--bg-tooltip);
        border: 1px solid var(--border-btn);
        border-radius: 7px;
        padding: 8px 12px;
        font-size: 12px;
        line-height: 1.45;
        max-width: 280px;
        z-index: 300;
        display: none;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }

      #tooltip .tt-name {
        font-weight: 600;
        color: var(--text-heading);
      }
      #tooltip .tt-sub {
        color: var(--text-sub);
        font-size: 11px;
      }

      /* ── Stats Bar ──────────────────────────────── */
      #stats-bar {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 6px 24px;
        background: var(--bg-tier);
        border-top: 1px solid var(--border-light);
        font-size: 11px;
        color: var(--text-dim);
        flex-shrink: 0;
      }

      #stats-bar strong {
        color: var(--text-sub);
      }

      @media (max-width: 900px) {
        #detail-panel {
          width: 260px;
          min-width: 260px;
        }
        .topic-label {
          width: 180px;
          min-width: 180px;
        }
      }
    </style>
  </head>
  <body>
    <div id="header">
      <h1>Practice Chain</h1>
      <span class="subtitle" id="subtitle">Loading...</span>
      <div id="search-wrap">
        <span id="search-icon">&#128269;</span>
        <input type="text" id="search" placeholder="Search practices..." autocomplete="off" />
      </div>
      <div class="header-controls">
        <button class="hdr-btn" id="prev-btn" title="Previous practice" disabled>&#9664;</button>
        <button class="hdr-btn" id="next-btn" title="Next practice" disabled>&#9654;</button>
        <div class="hdr-sep"></div>
        <button class="hdr-btn" id="zoom-out" title="Smaller dots">&minus;</button>
        <span class="hdr-label" id="zoom-level">100%</span>
        <button class="hdr-btn" id="zoom-in" title="Bigger dots">+</button>
        <div class="hdr-sep"></div>
        <button class="hdr-btn" id="theme-toggle" title="Toggle light/dark">&#9788;</button>
      </div>
    </div>

    <div id="content">
      <div id="tracks"></div>
      <button id="toggle-panel" title="Toggle detail panel">&#9664;</button>
      <div id="detail-panel">
        <div id="detail-header">
          <h2 id="detail-title">Practice Details</h2>
          <div id="detail-meta"></div>
        </div>
        <div id="detail-body">
          <div id="empty-state">
            <div class="icon">&#9675;</div>
            <p>
              Click any <strong>dot</strong> to see its name, prerequisites, and what it unlocks
            </p>
          </div>
        </div>
      </div>
    </div>

    <div id="stats-bar">
      <span>Showing <strong id="vis-count">0</strong> practices</span>
      <span id="search-status"></span>
    </div>

    <div id="tooltip"></div>

    <script>
      (async function () {
        const resp = await fetch("practices_data.json");
        const DATA = await resp.json();
        const nodes = DATA.nodes;
        const links = DATA.links;

        const nodeById = new Map(nodes.map((n) => [n.id, n]));

        // Progress tracking - load from localStorage
        const STORAGE_KEY = "practice_progress";
        const progress = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");

        function saveProgress() {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
        }

        function setProgress(id, state) {
          if (state === "empty") delete progress[id];
          else progress[id] = state;
          saveProgress();
          applyDotProgress(id);
        }

        function applyDotProgress(id) {
          const el = allDotEls[id];
          if (!el) return;
          el.classList.remove("progress-half", "progress-full", "progress-fail");
          const state = progress[id];
          if (state) el.classList.add("progress-" + state);
        }

        // Adjacency maps
        const forward = {};
        const backward = {};
        links.forEach((l) => {
          const s = typeof l.source === "object" ? l.source.id : l.source;
          const t = typeof l.target === "object" ? l.target.id : l.target;
          if (!forward[s]) forward[s] = [];
          forward[s].push({ id: t, type: l.type });
          if (!backward[t]) backward[t] = [];
          backward[t].push({ id: s, type: l.type });
        });

        const tierOrder = [0, 1, 2, 3, 4];
        const tierNames = {
          0: "Foundation",
          1: "Core",
          2: "Bridge",
          3: "Advanced",
          4: "Capstone",
        };
        const tierColors = {
          0: "#4ade80",
          1: "#38bdf8",
          2: "#a78bfa",
          3: "#f97316",
          4: "#f43f5e",
        };

        const topicsByTier = {};
        const topicNodes = {};
        const topicInfo = {};

        nodes.forEach((n) => {
          if (!topicsByTier[n.tier]) topicsByTier[n.tier] = new Set();
          topicsByTier[n.tier].add(n.topic);
          if (!topicNodes[n.topic]) topicNodes[n.topic] = [];
          topicNodes[n.topic].push(n);
          if (!topicInfo[n.topic]) {
            topicInfo[n.topic] = {
              num: n.topic,
              name: n.topicName,
              tier: n.tier,
              color: n.color,
            };
          }
        });

        function groupByGrade(topicNum) {
          const groups = {};
          topicNodes[topicNum].forEach((n) => {
            if (!groups[n.grade]) groups[n.grade] = [];
            groups[n.grade].push(n);
          });
          return Object.keys(groups).map(Number).sort((a, b) => a - b)
            .map((g) => ({ grade: g, label: groups[g][0].gradeLabel, nodes: groups[g] }));
        }

        /* ── Build DOM ────────────────────────────── */
        const tracksEl = document.getElementById("tracks");
        const allDotEls = {};

        tierOrder.forEach((tier) => {
          const topics = topicsByTier[tier];
          if (!topics) return;
          const sortedTopics = [...topics].sort((a, b) => a - b);

          const tierHdr = document.createElement("div");
          tierHdr.className = "tier-header";
          const tierCount = sortedTopics.reduce((sum, t) => sum + topicNodes[t].length, 0);
          tierHdr.innerHTML = `
      <div class="tier-dot" style="border:1.5px solid ${
            tierColors[tier]
          };border-radius:50%;background:transparent"></div>
      ${tierNames[tier]}
      <span class="tier-count">${sortedTopics.length} topics &middot; ${tierCount} practices</span>
      <span class="chevron">&#9660;</span>
    `;

          const tierBody = document.createElement("div");
          tierBody.className = "tier-body";

          tierHdr.addEventListener("click", () => {
            tierHdr.classList.toggle("collapsed");
            tierBody.classList.toggle("collapsed");
          });

          sortedTopics.forEach((topicNum) => {
            const info = topicInfo[topicNum];
            const gradeGroups = groupByGrade(topicNum);

            const row = document.createElement("div");
            row.className = "topic-row";
            row.dataset.topic = topicNum;

            const label = document.createElement("div");
            label.className = "topic-label";
            label.innerHTML = `
        <span class="topic-num">${String(topicNum).padStart(2, "0")}.</span>
        <span class="topic-name">${info.name}</span>
        <span class="topic-count">${topicNodes[topicNum].length}</span>
      `;

            const strip = document.createElement("div");
            strip.className = "topic-practices";

            gradeGroups.forEach((gg, gi) => {
              const gradeGroup = document.createElement("div");
              gradeGroup.className = "grade-group";

              const tag = document.createElement("span");
              tag.className = "grade-tag";
              tag.textContent = gg.label;
              gradeGroup.appendChild(tag);

              gg.nodes.forEach((n) => {
                const dot = document.createElement("span");
                dot.className = "dot";
                dot.dataset.id = n.id;

                // Apply saved progress state
                const state = progress[n.id];
                if (state) dot.classList.add("progress-" + state);

                dot.addEventListener("mouseenter", (e) => showTooltip(e, n));
                dot.addEventListener("mousemove", (e) => moveTooltip(e));
                dot.addEventListener("mouseleave", hideTooltip);
                dot.addEventListener("click", (e) => {
                  e.stopPropagation();
                  selectPractice(n);
                });

                gradeGroup.appendChild(dot);
                allDotEls[n.id] = dot;
              });

              strip.appendChild(gradeGroup);

              if (gi < gradeGroups.length - 1) {
                const sep = document.createElement("span");
                sep.className = "grade-sep";
                strip.appendChild(sep);
              }
            });

            row.appendChild(label);
            row.appendChild(strip);
            tierBody.appendChild(row);
          });

          tracksEl.appendChild(tierHdr);
          tracksEl.appendChild(tierBody);
        });

        document.getElementById("subtitle").textContent =
          `${nodes.length.toLocaleString()} exercises \u00B7 ${
            Object.keys(topicInfo).length
          } topics`;
        document.getElementById("vis-count").textContent = nodes.length.toLocaleString();

        /* ── Tooltip ──────────────────────────────── */
        const tooltip = document.getElementById("tooltip");

        function showTooltip(e, n) {
          const state = progress[n.id];
          const statusText = state === "full"
            ? " \u2714 Mastered"
            : state === "half"
            ? " \u25D0 Partial"
            : state === "fail"
            ? " \u2715 Failed"
            : "";
          tooltip.innerHTML = `
      <div class="tt-name">${n.name}${
            statusText
              ? '<span style="margin-left:6px;font-size:10px;opacity:0.7">' + statusText +
                "</span>"
              : ""
          }</div>
      <div class="tt-sub">${
            String(n.topic).padStart(2, "0")
          }. ${n.topicName} &middot; ${n.gradeLabel}${
            n.unit ? " &middot; " + n.unit : ""
          }</div>
    `;
          tooltip.style.display = "block";
          moveTooltip(e);
        }

        function moveTooltip(e) {
          let x = e.clientX + 14, y = e.clientY - 10;
          const tw = tooltip.offsetWidth, th = tooltip.offsetHeight;
          if (x + tw > window.innerWidth - 10) x = e.clientX - tw - 10;
          if (y + th > window.innerHeight - 10) y = e.clientY - th - 10;
          tooltip.style.left = x + "px";
          tooltip.style.top = y + "px";
        }

        function hideTooltip() {
          tooltip.style.display = "none";
        }

        /* ── Selection & Chain ────────────────────── */
        let selectedId = null;

        function selectPractice(n) {
          if (selectedId === n.id) {
            clearSelection();
            return;
          }
          selectedId = n.id;

          // BFS backward
          const prereqSet = new Set([n.id]);
          const directPrereqs = new Set();
          let bq = [n.id];
          while (bq.length) {
            const cur = bq.shift();
            (backward[cur] || []).forEach((l) => {
              if (!prereqSet.has(l.id)) {
                prereqSet.add(l.id);
                bq.push(l.id);
              }
              if (cur === n.id) directPrereqs.add(l.id);
            });
          }

          // BFS forward
          const unlockSet = new Set([n.id]);
          const directUnlocks = new Set();
          let fq = [n.id];
          while (fq.length) {
            const cur = fq.shift();
            (forward[cur] || []).forEach((l) => {
              if (!unlockSet.has(l.id)) {
                unlockSet.add(l.id);
                fq.push(l.id);
              }
              if (cur === n.id) directUnlocks.add(l.id);
            });
          }

          const chainSet = new Set([...prereqSet, ...unlockSet]);

          Object.entries(allDotEls).forEach(([id, el]) => {
            el.classList.remove(
              "selected",
              "prereq",
              "unlock",
              "chain",
              "dimmed",
              "search-match",
              "search-miss",
            );
            if (id === n.id) el.classList.add("selected");
            else if (directPrereqs.has(id)) el.classList.add("prereq");
            else if (directUnlocks.has(id)) el.classList.add("unlock");
            else if (chainSet.has(id)) el.classList.add("chain");
            else el.classList.add("dimmed");
          });

          document.querySelectorAll(".topic-row").forEach((r) =>
            r.classList.remove("active-topic")
          );
          const row = document.querySelector(`.topic-row[data-topic="${n.topic}"]`);
          if (row) row.classList.add("active-topic");

          updateDetailPanel(n, directPrereqs, directUnlocks, prereqSet, unlockSet);
          updateNavButtons();

          const dotEl = allDotEls[n.id];
          if (dotEl) {
            dotEl.scrollIntoView({
              behavior: "smooth",
              block: "nearest",
              inline: "nearest",
            });
          }
        }

        function clearSelection() {
          selectedId = null;
          Object.values(allDotEls).forEach((el) => {
            el.classList.remove(
              "selected",
              "prereq",
              "unlock",
              "chain",
              "dimmed",
              "search-match",
              "search-miss",
            );
          });
          document.querySelectorAll(".topic-row").forEach((r) =>
            r.classList.remove("active-topic")
          );
          resetDetailPanel();
          updateNavButtons();
        }

        /* ── Detail Panel ─────────────────────────── */
        function updateDetailPanel(n, prereqIds, unlockIds, allPrereqs, allUnlocks) {
          document.getElementById("detail-title").textContent = n.name;
          document.getElementById("detail-meta").innerHTML = `
      <div>${n.gradeLabel}${n.unit ? " &middot; " + n.unit : ""}</div>
      <div class="topic-badge">
        <div class="mini-dot"></div>
        ${String(n.topic).padStart(2, "0")}. ${n.topicName}
      </div>
    `;

          const body = document.getElementById("detail-body");
          body.innerHTML = "";

          // Start Practice button
          const startSec = document.createElement("div");
          startSec.className = "detail-section";
          startSec.innerHTML =
            `<button class="start-practice-btn">&#9654; Start Practice</button>`;
          startSec.querySelector("button").addEventListener("click", () => {
            // Mark as half-filled (in progress) automatically
            setProgress(n.id, "half");
            // Search Khan Academy for this practice
            const q = encodeURIComponent(n.name + " Khan Academy");
            window.open(
              "https://www.khanacademy.org/search?referer=%2F&page_search_query=" +
                encodeURIComponent(n.name),
              "_blank",
            );
          });
          body.appendChild(startSec);

          // Auto-progress: Mark complete / fail buttons
          const currentState = progress[n.id] || "empty";
          const resultSec = document.createElement("div");
          resultSec.className = "detail-section";
          resultSec.innerHTML = `
      <h3>&#128202; Result</h3>
      <div style="display:flex;gap:6px">
        <button class="start-practice-btn" data-result="full" style="background:${
            currentState === "full" ? "var(--accent)" : "var(--bg-btn)"
          };color:${
            currentState === "full" ? "#fff" : "var(--text-sub)"
          };font-size:12px;padding:8px;border:1px solid var(--border-btn)">&#10003; Mastered</button>
        <button class="start-practice-btn" data-result="half" style="background:${
            currentState === "half" ? "var(--accent)" : "var(--bg-btn)"
          };color:${
            currentState === "half" ? "#fff" : "var(--text-sub)"
          };font-size:12px;padding:8px;border:1px solid var(--border-btn)">&#9680; Partial</button>
        <button class="start-practice-btn" data-result="fail" style="background:${
            currentState === "fail" ? "#ef4444" : "var(--bg-btn)"
          };color:${
            currentState === "fail" ? "#fff" : "var(--text-sub)"
          };font-size:12px;padding:8px;border:1px solid var(--border-btn)">&#10007; Failed</button>
        <button class="start-practice-btn" data-result="empty" style="background:var(--bg-btn);color:var(--text-sub);font-size:12px;padding:8px;border:1px solid var(--border-btn)">&#8635; Reset</button>
      </div>
    `;
          resultSec.querySelectorAll("[data-result]").forEach((btn) => {
            btn.addEventListener("click", () => {
              setProgress(n.id, btn.dataset.result);
              // Re-render panel to update button highlights
              updateDetailPanel(n, prereqIds, unlockIds, allPrereqs, allUnlocks);
            });
          });
          body.appendChild(resultSec);

          // Prerequisites
          if (prereqIds.size > 0) {
            const sec = document.createElement("div");
            sec.className = "detail-section";
            sec.innerHTML =
              `<h3><span style="color:#fbbf24">&#9664;</span> Prerequisites <span class="badge">${prereqIds.size}</span></h3>`;

            [...prereqIds].map((id) => nodeById.get(id)).filter(Boolean)
              .sort((a, b) => a.topic - b.topic || a.grade - b.grade)
              .forEach((pn) => {
                const item = document.createElement("div");
                item.className = "dep-item";
                item.innerHTML = `
            <span class="arrow" style="color:#fbbf24">&#9664;</span>
            <span class="dep-name">${pn.name}</span>
            <span class="dep-context">${pn.gradeLabel}</span>
          `;
                item.addEventListener("click", () => selectPractice(pn));
                sec.appendChild(item);
              });
            body.appendChild(sec);
          }

          // Unlocks
          if (unlockIds.size > 0) {
            const sec = document.createElement("div");
            sec.className = "detail-section";
            sec.innerHTML =
              `<h3><span style="color:#38bdf8">&#9654;</span> Unlocks <span class="badge">${unlockIds.size}</span></h3>`;

            [...unlockIds].map((id) => nodeById.get(id)).filter(Boolean)
              .sort((a, b) => a.topic - b.topic || a.grade - b.grade)
              .forEach((un) => {
                const item = document.createElement("div");
                item.className = "dep-item";
                item.innerHTML = `
            <span class="arrow" style="color:#38bdf8">&#9654;</span>
            <span class="dep-name">${un.name}</span>
            <span class="dep-context">${un.gradeLabel}</span>
          `;
                item.addEventListener("click", () => selectPractice(un));
                sec.appendChild(item);
              });
            body.appendChild(sec);
          }

          // Stuck hint
          if (prereqIds.size > 0) {
            const hint = document.createElement("div");
            hint.className = "detail-section";
            hint.innerHTML = `
        <h3>&#128161; Stuck?</h3>
        <p style="font-size:12px;color:var(--text-sub);line-height:1.5">
          Click any <span style="color:#fbbf24">prerequisite</span> above to review it first.
          Master those, then come back to continue.
        </p>
      `;
            body.appendChild(hint);
          }

          // Chain stats
          const stats = document.createElement("div");
          stats.className = "detail-section";
          stats.innerHTML = `
      <h3>Chain Summary</h3>
      <div style="font-size:12px;color:var(--text-sub);line-height:1.8">
        <div><span style="color:#fbbf24">&#9664;</span> ${
            allPrereqs.size - 1
          } total prerequisites in chain</div>
        <div><span style="color:#38bdf8">&#9654;</span> ${
            allUnlocks.size - 1
          } practices unlocked after this</div>
      </div>
    `;
          body.appendChild(stats);
        }

        function resetDetailPanel() {
          document.getElementById("detail-title").textContent = "Practice Details";
          document.getElementById("detail-meta").innerHTML = "";
          document.getElementById("detail-body").innerHTML = `
      <div id="empty-state">
        <div class="icon">&#9675;</div>
        <p>Click any <strong>dot</strong> to see its name, prerequisites, and what it unlocks</p>
      </div>
    `;
        }

        /* ── Search ───────────────────────────────── */
        const searchInput = document.getElementById("search");
        let searchTimeout = null;

        searchInput.addEventListener("input", () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(doSearch, 200);
        });

        function doSearch() {
          const q = searchInput.value.toLowerCase().trim();
          const statusEl = document.getElementById("search-status");

          if (!q) {
            Object.values(allDotEls).forEach((el) =>
              el.classList.remove("search-match", "search-miss")
            );
            statusEl.textContent = "";
            document.getElementById("vis-count").textContent = nodes.length
              .toLocaleString();
            return;
          }

          if (selectedId) clearSelection();

          let matchCount = 0;
          Object.entries(allDotEls).forEach(([id, el]) => {
            const n = nodeById.get(id);
            const ok = n.name.toLowerCase().includes(q) ||
              n.topicName.toLowerCase().includes(q);
            el.classList.toggle("search-match", ok);
            el.classList.toggle("search-miss", !ok);
            if (ok) matchCount++;
          });

          statusEl.textContent = `${matchCount} matches`;
          document.getElementById("vis-count").textContent = matchCount.toLocaleString();

          const first = document.querySelector(".dot.search-match");
          if (first) first.scrollIntoView({ behavior: "smooth", block: "center" });
        }

        searchInput.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            searchInput.value = "";
            doSearch();
            searchInput.blur();
          }
        });

        /* ── Toggle Panel ─────────────────────────── */
        const toggleBtn = document.getElementById("toggle-panel");
        const detailPanel = document.getElementById("detail-panel");
        let panelVisible = true;

        toggleBtn.addEventListener("click", () => {
          panelVisible = !panelVisible;
          detailPanel.classList.toggle("collapsed", !panelVisible);
          toggleBtn.classList.toggle("panel-hidden", !panelVisible);
          toggleBtn.innerHTML = panelVisible ? "&#9664;" : "&#9654;";
        });

        /* ── Click outside to deselect ────────────── */
        tracksEl.addEventListener("click", (e) => {
          if (!e.target.classList.contains("dot")) clearSelection();
        });

        resetDetailPanel();

        /* ── Zoom Controls ────────────────────────── */
        const zoomInBtn = document.getElementById("zoom-in");
        const zoomOutBtn = document.getElementById("zoom-out");
        const zoomLabel = document.getElementById("zoom-level");
        let currentZoom = 100;
        const baseSize = 18;

        function updateZoom() {
          const newSize = Math.round(baseSize * (currentZoom / 100));
          document.documentElement.style.setProperty("--dot-size", newSize + "px");
          zoomLabel.textContent = currentZoom + "%";
        }

        zoomInBtn.addEventListener("click", () => {
          if (currentZoom < 300) {
            currentZoom += 20;
            updateZoom();
          }
        });

        zoomOutBtn.addEventListener("click", () => {
          if (currentZoom > 40) {
            currentZoom -= 20;
            updateZoom();
          }
        });

        /* ── Navigation Buttons ───────────────────── */
        const prevBtn = document.getElementById("prev-btn");
        const nextBtn = document.getElementById("next-btn");

        const navOrder = nodes.slice().sort((a, b) => {
          if (a.tier !== b.tier) return a.tier - b.tier;
          if (a.topic !== b.topic) return a.topic - b.topic;
          return a.grade - b.grade;
        });

        function updateNavButtons() {
          if (!selectedId) {
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            return;
          }
          const idx = navOrder.findIndex((n) => n.id === selectedId);
          prevBtn.disabled = idx <= 0;
          nextBtn.disabled = idx >= navOrder.length - 1;
        }

        prevBtn.addEventListener("click", () => {
          if (!selectedId) return;
          const idx = navOrder.findIndex((n) => n.id === selectedId);
          if (idx > 0) selectPractice(navOrder[idx - 1]);
        });

        nextBtn.addEventListener("click", () => {
          if (!selectedId) return;
          const idx = navOrder.findIndex((n) => n.id === selectedId);
          if (idx < navOrder.length - 1) selectPractice(navOrder[idx + 1]);
        });

        /* ── Theme Toggle ─────────────────────────── */
        const themeToggle = document.getElementById("theme-toggle");
        const savedTheme = localStorage.getItem("practice_theme") || "dark";
        document.documentElement.setAttribute("data-theme", savedTheme);
        themeToggle.innerHTML = savedTheme === "dark" ? "&#9788;" : "&#9790;";

        themeToggle.addEventListener("click", () => {
          const current = document.documentElement.getAttribute("data-theme");
          const next = current === "dark" ? "light" : "dark";
          document.documentElement.setAttribute("data-theme", next);
          localStorage.setItem("practice_theme", next);
          themeToggle.innerHTML = next === "dark" ? "&#9788;" : "&#9790;";
        });
      })();
    </script>
  </body>
</html>
